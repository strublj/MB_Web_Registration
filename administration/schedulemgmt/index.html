<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Fire Mountain Merit Badge Registration</title>
        <link rel="stylesheet" href="../../styles/bootstrap.min.css" type="text/css" media="all">
        <link href="../../styles/jquery.bootgrid.min.css" rel="stylesheet" />
        <link href="../../styles/styles.css" rel="stylesheet" />
        <script src="../../scripts/jquery-3.2.1.min.js"></script>
        <script src="../../scripts/bootstrap.min.js"></script>
        <script src="../../scripts/jquery.bootgrid.min.js"></script>
        <script src="../../scripts/angular.min.js"></script>
        <script src="../../scripts/angular-messages.min.js"></script>
    </head>
    <body ng-app="app" ng-controller="formCtrl" id="mycontroller">
        <div class="container">
            <section id="intro" class="dont-print">
                <header>
                    <h2>Fire Mountain</h2>
                    <h2>Merit Badge Registration</h2>
                    <div id="logo_container" class="pull-right"><img src="http://firemtn.org/images/fm_logo_new_full_color_no_words.png" alt=""></div>
                </header>
            </section>  
            <div class="">
                <div class="col-sm-12">
                    <div class="well clearfix dont-print">
                        <div class="pull-left">
                            <h2 id="admin_title">Merit Badge Registration Administration</h2>
                        </div>
                        <div class="pull-right" style="padding-top: 25px">
                            <button type="button" class="btn btn-xs btn-primary" id="btn_logout" data-row-id="0">
                                <span class="glyphicon glyphicon-asterisk"></span>Logout</button>
                        </div>
                    </div>
                    <ul class="dont-print">
                        <li><a href="../">Home</a></li>
                        <li><a class="active" href="./">Schedule View/Generate</a></li>
                        <li id="Unit_Reg"><a href="../../registration">Unit Registration</a></li>
                    </ul>
                    <div class="inline-form-group dont-print">
                        <label class="control-label">Select Week:</label>
                        <select class="form-control inline-form" id="weekSel" name="weekSel" ng-model="weekSelected" ng-options="Week.week_text for Week in Weeks track by Week.week_id" ng-change="weekChanged()">
                        </select>
                        <button type="button" class="btn btn-xs btn-primary" id="btn_generate_schedule" data-row-id="0" ng-click="generateSchedule()">
                                <span class="glyphicon glyphicon-asterisk"></span>Generate / Regenerate Schedule</button>
                        <button type="button" class="btn btn-xs btn-primary" id="btn_print_schedule" data-row-id="0" ng-click="print()">
                                <span class="glyphicon glyphicon-print"></span>Print Schedule</button>
                    </div>
                    <div class="unit-schedule" ng-repeat="u in Units">
                        <h2>{{u.unit_type}} {{u.unit_number}} - {{u.council_name}}</h2>
                        <table class="scout-schedule">
                            <tr>
                                <th>Scout</th>
                                <th>{{u.start1}} - {{u.end1}}</th>
                                <th>{{u.start2}} - {{u.end2}}</th>
                                <th>{{u.start3}} - {{u.end3}}</th>
                                <th>{{u.start4}} - {{u.end4}}</th>
                            </tr>
                            <tr ng-repeat="s in u.scout_list">
                              <td>{{s.first_name}} {{s.last_name}}</td>
                              <td>{{s.class_list[1].mb_name}}</td>
                              <td>{{s.class_list[2].mb_name}}</td>
                              <td>{{s.class_list[3].mb_name}}</td>
                              <td>{{s.class_list[4].mb_name}}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            var app = angular.module('app', ['ngMessages']);
            app.controller('formCtrl', function($scope, $http) {
                /*
                 * Sets the Weeks
                 */
                $http.get("schedulesvc.php?action=getWeeks")
                    .then(function(response) {
                        $scope.Weeks = response.data;
                        $scope.weekSelected = $scope.Weeks[0];
                        $scope.weekChanged();
                    });
                    
                $scope.weekChanged = function() {
                  $http.get("schedulesvc.php?action=getScheduleByTroop&week=" + $scope.weekSelected.week_id)
                    .then(function(response) {
                        $scope.Units = response.data;
                    });
                };
                
                $scope.generateSchedule = function() {
                  $http.get("schedulesvc.php?action=buildSchedule&week=" + $scope.weekSelected.week_id)
                    .then(function(response) {
                        $scope.weekChanged();
                    });
                };
                
                $scope.print = function() {
                    window.print();
                };
            });
            
            $(document).ready(function () {

                //Validate admin rights
                $.ajax({
                    type: "POST",
                    url: "schedulesvc.php",
                    data: {'action': 'checkAdmin'},
                    dataType: "json",
                    success: function (response)
                    {
                        if(response.success != 'true')
                        {
                            window.location = "../../"
                        }
                        if(response.hasUnit == 'false')
                        {
                            $("#Unit_Reg").hide();
                        }
                    }
                });
            });
            
            // Logout button click
            $('#btn_logout').click(function() {
                $.ajax({
                    type: "POST",
                    url: "../../registration/registrationsvc.php",
                    data: {'action': 'logout'},
                    dataType: "json",
                    success: function (response)
                    {
                        if(response.success == 'true')
                        {
                            window.location = "../../"
                        }
                    }
                });
            });
        </script>
    </body>
</html>